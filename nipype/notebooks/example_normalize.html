
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Example 3: Normalize data to MNI template &#8212; MRI analysis in Python using Nipype, Nilearn and more</title>
    
  <link href="../../_static/css/theme.css" rel="stylesheet" />
  <link href="../../_static/css/index.c5995385ac14fb8791e8eb36b4908be2.css" rel="stylesheet" />

    
  <link rel="stylesheet"
    href="../../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="../../_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="../../_static/js/index.1c5a1a01449ed65a7b51.js">

    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/togglebutton.js"></script>
    <script src="../../_static/clipboard.min.js"></script>
    <script src="../../_static/copybutton.js"></script>
    <script async="async" kind="hypothesis" src="https://hypothes.is/embed.js"></script>
    <script >var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../../_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script >
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="../../_static/sphinx-thebe.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Example 4: 2nd-level Analysis" href="example_2ndlevel.html" />
    <link rel="prev" title="Example 2: 1st-level Analysis" href="example_1stlevel.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="en" />
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../../index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="../../_static/nipy_logo.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">MRI analysis in Python using Nipype, Nilearn and more</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../index.html">
   Welcome!
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../../overview.html">
   Workshop overview
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../setup.html">
   Setup for the workshop
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../outline.html">
   Outline
  </a>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../prerequisites.html">
   Course prerequisites
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/>
  <label for="toctree-checkbox-1">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../prerequisites/intro_to_shell.html">
     Introduction to the (unix) command line: bash
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../prerequisites/intro_to_git_and_github.html">
     Introduction to git and github
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../prerequisites/intro_jupyter.html">
     Introduction to the jupyter ecosystem &amp; notebooks
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../prerequisites/intro_python.html">
     Introduction to Python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../prerequisites/python_numpy.html">
     Introduction to NumPy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../prerequisites/python_scipy.html">
     Introduction to SciPy
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../prerequisites/python_visualization.html">
     Introduction to Visualization in python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../prerequisites/intro_statistics.html">
     Introduction to Statistics in python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../prerequisites/python_scikit.html">
     Introduction to scikit-learn &amp; scikit-image
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../data/data.html">
   Basics in data handling
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/>
  <label for="toctree-checkbox-2">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../data/image_manipulation_nibabel.html">
     Using Python for neuroimaging data - NiBabel
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../data/image_manipulation_nilearn.html">
     Using Python for neuroimaging data - Nilearn
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 current active has-children">
  <a class="reference internal" href="../nipype_overview.html">
   Nipype
  </a>
  <input checked="" class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/>
  <label for="toctree-checkbox-3">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul class="current">
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../nipype_intro.html">
     Introduction to Nipype
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/>
    <label for="toctree-checkbox-4">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="introduction_showcase.html">
       Nipype Showcase
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="introduction_quickstart.html">
       Nipype Quickstart
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="introduction_quickstart_non-neuroimaging.html">
       Nipype Quickstart - non-imaging
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../nipype_basics.html">
     Basic concepts
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-5" name="toctree-checkbox-5" type="checkbox"/>
    <label for="toctree-checkbox-5">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="basic_interfaces.html">
       Interfaces
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="basic_nodes.html">
       Nodes
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="basic_workflow.html">
       Workflows
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="basic_graph_visualization.html">
       Graph Visualization
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="basic_data_input.html">
       Data Input
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="basic_data_input_bids.html">
       Data input for BIDS datasets
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="basic_data_output.html">
       Data Output
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="basic_plugins.html">
       Using Nipype Plugins
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="basic_function_interface.html">
       Function Interface
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="basic_iteration.html">
       Iterables
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="basic_mapnodes.html">
       MapNode
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="basic_joinnodes.html">
       JoinNode, synchronize and itersource
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="basic_debug.html">
       Debugging Nipype Workflows
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="basic_execution_configuration.html">
       Execution Configuration Options
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 current active has-children">
    <a class="reference internal" href="../nipype_examples.html">
     Example workflows
    </a>
    <input checked="" class="toctree-checkbox" id="toctree-checkbox-6" name="toctree-checkbox-6" type="checkbox"/>
    <label for="toctree-checkbox-6">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul class="current">
     <li class="toctree-l3">
      <a class="reference internal" href="example_preprocessing.html">
       Example 1: Preprocessing Workflow
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="example_1stlevel.html">
       Example 2: 1st-level Analysis
      </a>
     </li>
     <li class="toctree-l3 current active">
      <a class="current reference internal" href="#">
       Example 3: Normalize data to MNI template
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="example_2ndlevel.html">
       Example 4: 2nd-level Analysis
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="handson_preprocessing.html">
       Hands-on 1: How to create a fMRI preprocessing workflow
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="handson_analysis.html">
       Hands-on 2: How to create a fMRI analysis workflow
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../nipype_advanced.html">
     Advanced concepts
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-7" name="toctree-checkbox-7" type="checkbox"/>
    <label for="toctree-checkbox-7">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="advanced_create_interfaces.html">
       Create interfaces
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="advanced_interfaces_caching.html">
       Interface caching
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="advanced_nipypecli.html">
       Nipype Command Line Interface
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="advanced_aws.html">
       Using Nipype with Amazon Web Services (AWS)
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="advanced_sphinx_ext.html">
       Sphinx extensions
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="advanced_spmmcr.html">
       Using SPM with MATLAB Common Runtime (MCR)
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="advanced_mipav.html">
       Using MIPAV, JIST, and CBS Tools
      </a>
     </li>
    </ul>
   </li>
   <li class="toctree-l2 has-children">
    <a class="reference internal" href="../nipype_resources.html">
     Resources
    </a>
    <input class="toctree-checkbox" id="toctree-checkbox-8" name="toctree-checkbox-8" type="checkbox"/>
    <label for="toctree-checkbox-8">
     <i class="fas fa-chevron-down">
     </i>
    </label>
    <ul>
     <li class="toctree-l3">
      <a class="reference internal" href="resources_installation.html">
       Download and install
      </a>
     </li>
     <li class="toctree-l3">
      <a class="reference internal" href="resources_help.html">
       Where to find help
      </a>
     </li>
    </ul>
   </li>
  </ul>
 </li>
 <li class="toctree-l1 has-children">
  <a class="reference internal" href="../../advanced.html">
   Advanced and specialized analyses
  </a>
  <input class="toctree-checkbox" id="toctree-checkbox-9" name="toctree-checkbox-9" type="checkbox"/>
  <label for="toctree-checkbox-9">
   <i class="fas fa-chevron-down">
   </i>
  </label>
  <ul>
   <li class="toctree-l2">
    <a class="reference internal" href="../../advanced/pybids.html">
     Introduction to
     <code class="docutils literal notranslate">
      <span class="pre">
       pybids
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../advanced/statistical_analyses_MRI.html">
     Nilearn GLM: statistical analyses of MRI in Python
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../advanced/functional_connectivity.html">
     Functional connectivity and resting state
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../advanced/machine_learning_preparation.html">
     Preparation Machine Learning
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../advanced/machine_learning_nilearn.html">
     MVPA and Searchlight with
     <code class="docutils literal notranslate">
      <span class="pre">
       nilearn
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../advanced/machine_learning_keras.html">
     <code class="docutils literal notranslate">
      <span class="pre">
       TensorFlow
      </span>
     </code>
     /
     <code class="docutils literal notranslate">
      <span class="pre">
       Keras
      </span>
     </code>
    </a>
   </li>
   <li class="toctree-l2">
    <a class="reference internal" href="../../advanced/Predicting_age_with_machine_learning.html">
     Machine learning to predict age from rs-fmri
    </a>
   </li>
  </ul>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../break.html">
   Yoga and/or dance break
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="../../CoC.html">
   Code of Conduct
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="../../_sources/nipype/notebooks/example_normalize.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/PeerHerholz/workshop_weizmann"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/PeerHerholz/workshop_weizmann/issues/new?title=Issue%20on%20page%20%2Fnipype/notebooks/example_normalize.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        <a class="edit-button" href="https://github.com/PeerHerholz/workshop_weizmann/edit/master/lecture/nipype/notebooks/example_normalize.ipynb"><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Edit this page"><i class="fas fa-pencil-alt"></i>suggest edit</button></a>
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Launch interactive content"><i class="fas fa-rocket"></i></button>
    <div class="dropdown-buttons">
        
        <a class="binder-button" href="https://mybinder.org/v2/gh/PeerHerholz/workshop_weizmann/master?urlpath=tree/lecture/nipype/notebooks/example_normalize.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Launch Binder" data-toggle="tooltip"
                data-placement="left"><img class="binder-button-logo"
                    src="../../_static/images/logo_binder.svg"
                    alt="Interact on binder">Binder</button></a>
        
        
        
        
    </div>
</div>

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#">
   Example 3: Normalize data to MNI template
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#preparation">
     Preparation
    </a>
    <ul class="nav section-nav flex-column">
     <li class="toc-h3 nav-item toc-entry">
      <a class="reference internal nav-link" href="#alternatively-prepare-yourself">
       Alternatively: Prepare yourself
      </a>
     </li>
    </ul>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#normalization-with-ants">
     Normalization with ANTs
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports-ants">
     Imports (ANTs)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#experiment-parameters-ants">
     Experiment parameters (ANTs)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specify-nodes-ants">
     Specify Nodes (ANTs)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specify-input-output-stream-ants">
     Specify input &amp; output stream (ANTs)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specify-workflow-ants">
     Specify Workflow (ANTs)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualize-the-workflow-ants">
     Visualize the workflow (ANTs)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-the-workflow-ants">
     Run the Workflow (ANTs)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#normalization-with-spm12">
   Normalization with SPM12
  </a>
  <ul class="visible nav section-nav flex-column">
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#imports-spm12">
     Imports (SPM12)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#experiment-parameters-spm12">
     Experiment parameters (SPM12)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specify-nodes-spm12">
     Specify Nodes (SPM12)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specify-input-output-stream-spm12">
     Specify input &amp; output stream (SPM12)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#specify-workflow-spm12">
     Specify Workflow (SPM12)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#visualize-the-workflow-spm12">
     Visualize the workflow (SPM12)
    </a>
   </li>
   <li class="toc-h2 nav-item toc-entry">
    <a class="reference internal nav-link" href="#run-the-workflow-spm12">
     Run the Workflow (SPM12)
    </a>
   </li>
  </ul>
 </li>
 <li class="toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="#comparison-between-ants-and-spm-normalization">
   Comparison between ANTs and SPM normalization
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="section" id="example-3-normalize-data-to-mni-template">
<h1>Example 3: Normalize data to MNI template<a class="headerlink" href="#example-3-normalize-data-to-mni-template" title="Permalink to this headline">¶</a></h1>
<p>This example covers the normalization of data. Some people prefer to normalize the data during the preprocessing, just before smoothing. I prefer to do the 1st-level analysis completely in subject space and only normalize the contrasts for the 2nd-level analysis. But both approaches are fine.</p>
<p>For the current example, we will take the computed 1st-level contrasts from the previous experiment (again once done with fwhm=4mm and fwhm=8mm) and normalize them into MNI-space. To show two different approaches, we will do the normalization once with ANTs and once with SPM.</p>
<div class="section" id="preparation">
<h2>Preparation<a class="headerlink" href="#preparation" title="Permalink to this headline">¶</a></h2>
<p>Before we can start with the ANTs example, we first need to download the already computed deformation field. The data can be found in the <code class="docutils literal notranslate"><span class="pre">derivatives/fmriprep</span></code> folder of the dataset and can be downloaded with the following <code class="docutils literal notranslate"><span class="pre">datalad</span></code> command:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%%</span><span class="k">bash</span>
datalad get -J 4 -d /data/ds000114 /data/ds000114/derivatives/fmriprep/sub-0[2345789]/anat/*h5
</pre></div>
</div>
</div>
</div>
<p><strong>Note:</strong> This might take a while, as datalad needs to download ~710MB of data</p>
<div class="section" id="alternatively-prepare-yourself">
<h3>Alternatively: Prepare yourself<a class="headerlink" href="#alternatively-prepare-yourself" title="Permalink to this headline">¶</a></h3>
<p>We’re using the precomputed warp field from <a class="reference external" href="http://fmriprep.readthedocs.io">fmriprep</a>, as this step otherwise would take up to 10 hours or more for all subjects to complete. If you’re nonetheless interested in computing the warp parameters with ANTs yourself, without using <a class="reference external" href="http://fmriprep.readthedocs.io">fmriprep</a>, either check out the script <a class="reference external" href="https://github.com/miykael/nipype_tutorial/blob/master/notebooks/scripts/ANTS_registration.py">ANTS_registration.py</a> or even quicker, use <a class="reference external" href="http://nipype.readthedocs.io/en/latest/interfaces/generated/interfaces.ants/registration.html#registrationsynquick">RegistrationSynQuick</a>, Nipype’s implementation of <code class="docutils literal notranslate"><span class="pre">antsRegistrationSynQuick.sh</span></code>.</p>
</div>
</div>
<div class="section" id="normalization-with-ants">
<h2>Normalization with ANTs<a class="headerlink" href="#normalization-with-ants" title="Permalink to this headline">¶</a></h2>
<p>The normalization with ANTs requires that you first compute the transformation matrix that would bring the anatomical images of each subject into template space. Depending on your system this might take a few hours per subject. To facilitate this step, the transformation matrix is already computed for the T1 images.</p>
<p>The data for it can be found under:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">!</span>ls /data/ds000114/derivatives/fmriprep/sub-*/anat/*h5
</pre></div>
</div>
</div>
</div>
<p><strong>Now, let’s start with the ANTs normalization workflow!</strong></p>
</div>
<div class="section" id="imports-ants">
<h2>Imports (ANTs)<a class="headerlink" href="#imports-ants" title="Permalink to this headline">¶</a></h2>
<p>First, we need to import all the modules we later want to use.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">opj</span>
<span class="kn">from</span> <span class="nn">nipype</span> <span class="kn">import</span> <span class="n">Workflow</span><span class="p">,</span> <span class="n">Node</span><span class="p">,</span> <span class="n">MapNode</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.ants</span> <span class="kn">import</span> <span class="n">ApplyTransforms</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.utility</span> <span class="kn">import</span> <span class="n">IdentityInterface</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.io</span> <span class="kn">import</span> <span class="n">SelectFiles</span><span class="p">,</span> <span class="n">DataSink</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.fsl</span> <span class="kn">import</span> <span class="n">Info</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="experiment-parameters-ants">
<h2>Experiment parameters (ANTs)<a class="headerlink" href="#experiment-parameters-ants" title="Permalink to this headline">¶</a></h2>
<p>It’s always a good idea to specify all parameters that might change between experiments at the beginning of your script. And remember that we decided to run the group analysis without subject <code class="docutils literal notranslate"><span class="pre">sub-01</span></code>, <code class="docutils literal notranslate"><span class="pre">sub-06</span></code> and <code class="docutils literal notranslate"><span class="pre">sub-10</span></code> because they are left-handed (see <a class="reference external" href="https://miykael.github.io/nipype_tutorial/notebooks/example_1stlevel.html#Special-case">this section</a>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">experiment_dir</span> <span class="o">=</span> <span class="s1">&#39;/output&#39;</span>
<span class="n">output_dir</span> <span class="o">=</span> <span class="s1">&#39;datasink&#39;</span>
<span class="n">working_dir</span> <span class="o">=</span> <span class="s1">&#39;workingdir&#39;</span>

<span class="c1"># list of subject identifiers (remember we use only right handed subjects)</span>
<span class="n">subject_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;02&#39;</span><span class="p">,</span> <span class="s1">&#39;03&#39;</span><span class="p">,</span> <span class="s1">&#39;04&#39;</span><span class="p">,</span> <span class="s1">&#39;05&#39;</span><span class="p">,</span> <span class="s1">&#39;07&#39;</span><span class="p">,</span> <span class="s1">&#39;08&#39;</span><span class="p">,</span> <span class="s1">&#39;09&#39;</span><span class="p">]</span>

<span class="c1"># task name</span>
<span class="n">task_name</span> <span class="o">=</span> <span class="s2">&quot;fingerfootlips&quot;</span>

<span class="c1"># Smoothing widths used during preprocessing</span>
<span class="n">fwhm</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>

<span class="c1"># Template to normalize to</span>
<span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;/data/ds000114/derivatives/fmriprep/mni_icbm152_nlin_asym_09c/1mm_T1.nii.gz&#39;</span>
</pre></div>
</div>
</div>
</div>
<p><strong>Note</strong> if you’re not using the corresponding docker image, than the <strong><code class="docutils literal notranslate"><span class="pre">template</span></code></strong> file might not be in your <code class="docutils literal notranslate"><span class="pre">data</span></code>  directory. To get <code class="docutils literal notranslate"><span class="pre">mni_icbm152_nlin_asym_09c</span></code>, either download it from this <a class="reference external" href="https://files.osf.io/v1/resources/fvuh8/providers/osfstorage/580705089ad5a101f17944a9">website</a>, unpack it and move it to <code class="docutils literal notranslate"><span class="pre">/data/ds000114/derivatives/fmriprep/</span></code> or run the following command in a cell:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>%%bash
curl -L https://files.osf.io/v1/resources/fvuh8/providers/osfstorage/580705089ad5a101f17944a9 <span class="se">\</span>
     -o /data/ds000114/derivatives/fmriprep/mni_icbm152_nlin_asym_09c.tar.gz
     
tar xf /data/ds000114/derivatives/fmriprep/mni_icbm152_nlin_asym_09c.tar.gz <span class="se">\</span>
    -C /data/ds000114/derivatives/fmriprep/.
    
rm /data/ds000114/derivatives/fmriprep/mni_icbm152_nlin_asym_09c.tar.gz
</pre></div>
</div>
</div>
<div class="section" id="specify-nodes-ants">
<h2>Specify Nodes (ANTs)<a class="headerlink" href="#specify-nodes-ants" title="Permalink to this headline">¶</a></h2>
<p>Initiate all the different interfaces (represented as nodes) that you want to use in your workflow.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Apply Transformation - applies the normalization matrix to contrast images</span>
<span class="n">apply2con</span> <span class="o">=</span> <span class="n">MapNode</span><span class="p">(</span><span class="n">ApplyTransforms</span><span class="p">(</span><span class="n">args</span><span class="o">=</span><span class="s1">&#39;--float&#39;</span><span class="p">,</span>
                                    <span class="n">input_image_type</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span>
                                    <span class="n">interpolation</span><span class="o">=</span><span class="s1">&#39;BSpline&#39;</span><span class="p">,</span>
                                    <span class="n">invert_transform_flags</span><span class="o">=</span><span class="p">[</span><span class="kc">False</span><span class="p">],</span>
                                    <span class="n">num_threads</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">reference_image</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
                                    <span class="n">terminal_output</span><span class="o">=</span><span class="s1">&#39;file&#39;</span><span class="p">),</span>
                    <span class="n">name</span><span class="o">=</span><span class="s1">&#39;apply2con&#39;</span><span class="p">,</span> <span class="n">iterfield</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;input_image&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="specify-input-output-stream-ants">
<h2>Specify input &amp; output stream (ANTs)<a class="headerlink" href="#specify-input-output-stream-ants" title="Permalink to this headline">¶</a></h2>
<p>Specify where the input data can be found &amp; where and how to save the output data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Infosource - a function free node to iterate over the list of subject names</span>
<span class="n">infosource</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;fwhm_id&#39;</span><span class="p">]),</span>
                  <span class="n">name</span><span class="o">=</span><span class="s2">&quot;infosource&quot;</span><span class="p">)</span>
<span class="n">infosource</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">subject_list</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;fwhm_id&#39;</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">)]</span>

<span class="c1"># SelectFiles - to grab the data (alternativ to DataGrabber)</span>
<span class="n">templates</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;con&#39;</span><span class="p">:</span> <span class="n">opj</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;1stLevel&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;sub-</span><span class="si">{subject_id}</span><span class="s1">/fwhm-</span><span class="si">{fwhm_id}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;???_00??.nii&#39;</span><span class="p">),</span>
             <span class="s1">&#39;transform&#39;</span><span class="p">:</span> <span class="n">opj</span><span class="p">(</span><span class="s1">&#39;/data/ds000114/derivatives/fmriprep/&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-</span><span class="si">{subject_id}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;anat&#39;</span><span class="p">,</span>
                              <span class="s1">&#39;sub-</span><span class="si">{subject_id}</span><span class="s1">_t1w_space-mni152nlin2009casym_warp.h5&#39;</span><span class="p">)}</span>
<span class="n">selectfiles</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">SelectFiles</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span>
                               <span class="n">base_directory</span><span class="o">=</span><span class="n">experiment_dir</span><span class="p">,</span>
                               <span class="n">sort_filelist</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                   <span class="n">name</span><span class="o">=</span><span class="s2">&quot;selectfiles&quot;</span><span class="p">)</span>

<span class="c1"># Datasink - creates output folder for important outputs</span>
<span class="n">datasink</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">DataSink</span><span class="p">(</span><span class="n">base_directory</span><span class="o">=</span><span class="n">experiment_dir</span><span class="p">,</span>
                         <span class="n">container</span><span class="o">=</span><span class="n">output_dir</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;datasink&quot;</span><span class="p">)</span>

<span class="c1"># Use the following DataSink output substitutions</span>
<span class="n">substitutions</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;_subject_id_&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-&#39;</span><span class="p">)]</span>
<span class="n">subjFolders</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;_fwhm_id_</span><span class="si">%s</span><span class="s1">sub-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sub</span><span class="p">),</span> <span class="s1">&#39;sub-</span><span class="si">%s</span><span class="s1">_fwhm</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
               <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fwhm</span>
               <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subject_list</span><span class="p">]</span>
<span class="n">subjFolders</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;_apply2con</span><span class="si">%s</span><span class="s1">/&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">),</span> <span class="s1">&#39;&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">9</span><span class="p">)]</span> <span class="c1"># number of contrast used in 1stlevel an.</span>
<span class="n">substitutions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subjFolders</span><span class="p">)</span>
<span class="n">datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">substitutions</span> <span class="o">=</span> <span class="n">substitutions</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="specify-workflow-ants">
<h2>Specify Workflow (ANTs)<a class="headerlink" href="#specify-workflow-ants" title="Permalink to this headline">¶</a></h2>
<p>Create a workflow and connect the interface nodes and the I/O stream to each other.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Initiation of the ANTs normalization workflow</span>
<span class="n">antsflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;antsflow&#39;</span><span class="p">)</span>
<span class="n">antsflow</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">experiment_dir</span><span class="p">,</span> <span class="n">working_dir</span><span class="p">)</span>

<span class="c1"># Connect up the ANTs normalization components</span>
<span class="n">antsflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">infosource</span><span class="p">,</span> <span class="n">selectfiles</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">),</span>
                                             <span class="p">(</span><span class="s1">&#39;fwhm_id&#39;</span><span class="p">,</span> <span class="s1">&#39;fwhm_id&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">selectfiles</span><span class="p">,</span> <span class="n">apply2con</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;con&#39;</span><span class="p">,</span> <span class="s1">&#39;input_image&#39;</span><span class="p">),</span>
                                            <span class="p">(</span><span class="s1">&#39;transform&#39;</span><span class="p">,</span> <span class="s1">&#39;transforms&#39;</span><span class="p">)]),</span>
                  <span class="p">(</span><span class="n">apply2con</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;output_image&#39;</span><span class="p">,</span> <span class="s1">&#39;norm_ants.@con&#39;</span><span class="p">)]),</span>
                  <span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="visualize-the-workflow-ants">
<h2>Visualize the workflow (ANTs)<a class="headerlink" href="#visualize-the-workflow-ants" title="Permalink to this headline">¶</a></h2>
<p>It always helps to visualize your workflow.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create ANTs normalization graph</span>
<span class="n">antsflow</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph2use</span><span class="o">=</span><span class="s1">&#39;colored&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">simple_form</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Visualize the graph</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">opj</span><span class="p">(</span><span class="n">antsflow</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;antsflow&#39;</span><span class="p">,</span> <span class="s1">&#39;graph.png&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="run-the-workflow-ants">
<h2>Run the Workflow (ANTs)<a class="headerlink" href="#run-the-workflow-ants" title="Permalink to this headline">¶</a></h2>
<p>Now that everything is ready, we can run the ANTs normalization workflow. Change <code class="docutils literal notranslate"><span class="pre">n_procs</span></code> to the number of jobs/cores you want to use.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">antsflow</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;MultiProc&#39;</span><span class="p">,</span> <span class="n">plugin_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;n_procs&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="normalization-with-spm12">
<h1>Normalization with SPM12<a class="headerlink" href="#normalization-with-spm12" title="Permalink to this headline">¶</a></h1>
<p>The normalization with SPM12 is rather straightforward. The only thing we need to do is run the Normalize12 module. <strong>So let’s start!</strong></p>
<div class="section" id="imports-spm12">
<h2>Imports (SPM12)<a class="headerlink" href="#imports-spm12" title="Permalink to this headline">¶</a></h2>
<p>First, we need to import all the modules we later want to use.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">opj</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.spm</span> <span class="kn">import</span> <span class="n">Normalize12</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.utility</span> <span class="kn">import</span> <span class="n">IdentityInterface</span>
<span class="kn">from</span> <span class="nn">nipype.interfaces.io</span> <span class="kn">import</span> <span class="n">SelectFiles</span><span class="p">,</span> <span class="n">DataSink</span>
<span class="kn">from</span> <span class="nn">nipype.algorithms.misc</span> <span class="kn">import</span> <span class="n">Gunzip</span>
<span class="kn">from</span> <span class="nn">nipype</span> <span class="kn">import</span> <span class="n">Workflow</span><span class="p">,</span> <span class="n">Node</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="experiment-parameters-spm12">
<h2>Experiment parameters (SPM12)<a class="headerlink" href="#experiment-parameters-spm12" title="Permalink to this headline">¶</a></h2>
<p>It’s always a good idea to specify all parameters that might change between experiments at the beginning of your script. And remember that we decided to run the group analysis without subject <code class="docutils literal notranslate"><span class="pre">sub-01</span></code>, <code class="docutils literal notranslate"><span class="pre">sub-06</span></code> and <code class="docutils literal notranslate"><span class="pre">sub-10</span></code> because they are left-handed (see <a class="reference external" href="https://miykael.github.io/nipype_tutorial/notebooks/example_1stlevel.html#Special-case">this section</a>).</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">experiment_dir</span> <span class="o">=</span> <span class="s1">&#39;/output&#39;</span>
<span class="n">output_dir</span> <span class="o">=</span> <span class="s1">&#39;datasink&#39;</span>
<span class="n">working_dir</span> <span class="o">=</span> <span class="s1">&#39;workingdir&#39;</span>

<span class="c1"># list of subject identifiers</span>
<span class="n">subject_list</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;02&#39;</span><span class="p">,</span> <span class="s1">&#39;03&#39;</span><span class="p">,</span> <span class="s1">&#39;04&#39;</span><span class="p">,</span> <span class="s1">&#39;05&#39;</span><span class="p">,</span> <span class="s1">&#39;07&#39;</span><span class="p">,</span> <span class="s1">&#39;08&#39;</span><span class="p">,</span> <span class="s1">&#39;09&#39;</span><span class="p">]</span>

<span class="c1"># task name</span>
<span class="n">task_name</span> <span class="o">=</span> <span class="s2">&quot;fingerfootlips&quot;</span>

<span class="c1"># Smoothing withds used during preprocessing</span>
<span class="n">fwhm</span> <span class="o">=</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span> <span class="mi">8</span><span class="p">]</span>

<span class="n">template</span> <span class="o">=</span> <span class="s1">&#39;/opt/spm12-r7219/spm12_mcr/spm12/tpm/TPM.nii&#39;</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="specify-nodes-spm12">
<h2>Specify Nodes (SPM12)<a class="headerlink" href="#specify-nodes-spm12" title="Permalink to this headline">¶</a></h2>
<p>Initiate all the different interfaces (represented as nodes) that you want to use in your workflow.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Gunzip - unzip the anatomical image</span>
<span class="n">gunzip</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">Gunzip</span><span class="p">(),</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;gunzip&quot;</span><span class="p">)</span>

<span class="c1"># Normalize - normalizes functional and structural images to the MNI template</span>
<span class="n">normalize</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">Normalize12</span><span class="p">(</span><span class="n">jobtype</span><span class="o">=</span><span class="s1">&#39;estwrite&#39;</span><span class="p">,</span>
                             <span class="n">tpm</span><span class="o">=</span><span class="n">template</span><span class="p">,</span>
                             <span class="n">write_voxel_sizes</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">]),</span>
                 <span class="n">name</span><span class="o">=</span><span class="s2">&quot;normalize&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="specify-input-output-stream-spm12">
<h2>Specify input &amp; output stream (SPM12)<a class="headerlink" href="#specify-input-output-stream-spm12" title="Permalink to this headline">¶</a></h2>
<p>Specify where the input data can be found &amp; where and how to save the output data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Infosource - a function free node to iterate over the list of subject names</span>
<span class="n">infosource</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">IdentityInterface</span><span class="p">(</span><span class="n">fields</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;fwhm_id&#39;</span><span class="p">]),</span>
                  <span class="n">name</span><span class="o">=</span><span class="s2">&quot;infosource&quot;</span><span class="p">)</span>
<span class="n">infosource</span><span class="o">.</span><span class="n">iterables</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="n">subject_list</span><span class="p">),</span>
                        <span class="p">(</span><span class="s1">&#39;fwhm_id&#39;</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">)]</span>

<span class="c1"># SelectFiles - to grab the data (alternativ to DataGrabber)</span>
<span class="n">templates</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;con&#39;</span><span class="p">:</span> <span class="n">opj</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="s1">&#39;1stLevel&#39;</span><span class="p">,</span>
                        <span class="s1">&#39;sub-</span><span class="si">{subject_id}</span><span class="s1">/fwhm-</span><span class="si">{fwhm_id}</span><span class="s1">&#39;</span><span class="p">,</span> <span class="s1">&#39;???_00??.nii&#39;</span><span class="p">),</span>
             <span class="s1">&#39;anat&#39;</span><span class="p">:</span> <span class="n">opj</span><span class="p">(</span><span class="s1">&#39;/data/ds000114/derivatives&#39;</span><span class="p">,</span> <span class="s1">&#39;fmriprep&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-</span><span class="si">{subject_id}</span><span class="s1">&#39;</span><span class="p">,</span>
                         <span class="s1">&#39;anat&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-</span><span class="si">{subject_id}</span><span class="s1">_t1w_preproc.nii.gz&#39;</span><span class="p">)}</span>

<span class="n">selectfiles</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">SelectFiles</span><span class="p">(</span><span class="n">templates</span><span class="p">,</span>
                               <span class="n">base_directory</span><span class="o">=</span><span class="n">experiment_dir</span><span class="p">,</span>
                               <span class="n">sort_filelist</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
                   <span class="n">name</span><span class="o">=</span><span class="s2">&quot;selectfiles&quot;</span><span class="p">)</span>

<span class="c1"># Datasink - creates output folder for important outputs</span>
<span class="n">datasink</span> <span class="o">=</span> <span class="n">Node</span><span class="p">(</span><span class="n">DataSink</span><span class="p">(</span><span class="n">base_directory</span><span class="o">=</span><span class="n">experiment_dir</span><span class="p">,</span>
                         <span class="n">container</span><span class="o">=</span><span class="n">output_dir</span><span class="p">),</span>
                <span class="n">name</span><span class="o">=</span><span class="s2">&quot;datasink&quot;</span><span class="p">)</span>

<span class="c1"># Use the following DataSink output substitutions</span>
<span class="n">substitutions</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;_subject_id_&#39;</span><span class="p">,</span> <span class="s1">&#39;sub-&#39;</span><span class="p">)]</span>
<span class="n">subjFolders</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;_fwhm_id_</span><span class="si">%s</span><span class="s1">sub-</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">sub</span><span class="p">),</span> <span class="s1">&#39;sub-</span><span class="si">%s</span><span class="s1">_fwhm</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">f</span><span class="p">))</span>
               <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">fwhm</span>
               <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">subject_list</span><span class="p">]</span>
<span class="n">substitutions</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">subjFolders</span><span class="p">)</span>
<span class="n">datasink</span><span class="o">.</span><span class="n">inputs</span><span class="o">.</span><span class="n">substitutions</span> <span class="o">=</span> <span class="n">substitutions</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="specify-workflow-spm12">
<h2>Specify Workflow (SPM12)<a class="headerlink" href="#specify-workflow-spm12" title="Permalink to this headline">¶</a></h2>
<p>Create a workflow and connect the interface nodes and the I/O stream to each other.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Specify Normalization-Workflow &amp; Connect Nodes</span>
<span class="n">spmflow</span> <span class="o">=</span> <span class="n">Workflow</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;spmflow&#39;</span><span class="p">)</span>
<span class="n">spmflow</span><span class="o">.</span><span class="n">base_dir</span> <span class="o">=</span> <span class="n">opj</span><span class="p">(</span><span class="n">experiment_dir</span><span class="p">,</span> <span class="n">working_dir</span><span class="p">)</span>

<span class="c1"># Connect up SPM normalization components</span>
<span class="n">spmflow</span><span class="o">.</span><span class="n">connect</span><span class="p">([(</span><span class="n">infosource</span><span class="p">,</span> <span class="n">selectfiles</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;subject_id&#39;</span><span class="p">,</span> <span class="s1">&#39;subject_id&#39;</span><span class="p">),</span>
                                            <span class="p">(</span><span class="s1">&#39;fwhm_id&#39;</span><span class="p">,</span> <span class="s1">&#39;fwhm_id&#39;</span><span class="p">)]),</span>
                 <span class="p">(</span><span class="n">selectfiles</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;con&#39;</span><span class="p">,</span> <span class="s1">&#39;apply_to_files&#39;</span><span class="p">)]),</span>
                 <span class="p">(</span><span class="n">selectfiles</span><span class="p">,</span> <span class="n">gunzip</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;anat&#39;</span><span class="p">,</span> <span class="s1">&#39;in_file&#39;</span><span class="p">)]),</span>
                 <span class="p">(</span><span class="n">gunzip</span><span class="p">,</span> <span class="n">normalize</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;out_file&#39;</span><span class="p">,</span> <span class="s1">&#39;image_to_align&#39;</span><span class="p">)]),</span>
                 <span class="p">(</span><span class="n">normalize</span><span class="p">,</span> <span class="n">datasink</span><span class="p">,</span> <span class="p">[(</span><span class="s1">&#39;normalized_files&#39;</span><span class="p">,</span> <span class="s1">&#39;norm_spm.@files&#39;</span><span class="p">),</span>
                                        <span class="p">(</span><span class="s1">&#39;normalized_image&#39;</span><span class="p">,</span> <span class="s1">&#39;norm_spm.@image&#39;</span><span class="p">),</span>
                                        <span class="p">]),</span>
                 <span class="p">])</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="visualize-the-workflow-spm12">
<h2>Visualize the workflow (SPM12)<a class="headerlink" href="#visualize-the-workflow-spm12" title="Permalink to this headline">¶</a></h2>
<p>It always helps to visualize your workflow.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create SPM normalization graph</span>
<span class="n">spmflow</span><span class="o">.</span><span class="n">write_graph</span><span class="p">(</span><span class="n">graph2use</span><span class="o">=</span><span class="s1">&#39;colored&#39;</span><span class="p">,</span> <span class="nb">format</span><span class="o">=</span><span class="s1">&#39;png&#39;</span><span class="p">,</span> <span class="n">simple_form</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="c1"># Visualize the graph</span>
<span class="kn">from</span> <span class="nn">IPython.display</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="n">Image</span><span class="p">(</span><span class="n">filename</span><span class="o">=</span><span class="n">opj</span><span class="p">(</span><span class="n">spmflow</span><span class="o">.</span><span class="n">base_dir</span><span class="p">,</span> <span class="s1">&#39;spmflow&#39;</span><span class="p">,</span> <span class="s1">&#39;graph.png&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="run-the-workflow-spm12">
<h2>Run the Workflow (SPM12)<a class="headerlink" href="#run-the-workflow-spm12" title="Permalink to this headline">¶</a></h2>
<p>Now that everything is ready, we can run the SPM normalization workflow. Change <code class="docutils literal notranslate"><span class="pre">n_procs</span></code> to the number of jobs/cores you want to use.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">spmflow</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="s1">&#39;MultiProc&#39;</span><span class="p">,</span> <span class="n">plugin_args</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;n_procs&#39;</span><span class="p">:</span> <span class="mi">4</span><span class="p">})</span>
</pre></div>
</div>
</div>
</div>
</div>
</div>
<div class="section" id="comparison-between-ants-and-spm-normalization">
<h1>Comparison between ANTs and SPM normalization<a class="headerlink" href="#comparison-between-ants-and-spm-normalization" title="Permalink to this headline">¶</a></h1>
<p>Now that we ran the normalization with ANTs and SPM, let us compare their output.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nilearn.plotting</span> <span class="kn">import</span> <span class="n">plot_stat_map</span>
<span class="o">%</span><span class="k">matplotlib</span> inline
<span class="n">anatimg</span> <span class="o">=</span> <span class="s1">&#39;/data/ds000114/derivatives/fmriprep/mni_icbm152_nlin_asym_09c/1mm_T1.nii.gz&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>First, let’s compare the normalization of the <strong>anatomical</strong> images:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_stat_map</span><span class="p">(</span>
    <span class="s1">&#39;/data/ds000114/derivatives/fmriprep/sub-02/anat/sub-02_t1w_space-mni152nlin2009casym_preproc.nii.gz&#39;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;anatomy - ANTs (normalized to ICBM152)&#39;</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">anatimg</span><span class="p">,</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">,</span> <span class="n">cut_coords</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">));</span>
<span class="n">plot_stat_map</span><span class="p">(</span>
    <span class="s1">&#39;/output/datasink/norm_spm/sub-02_fwhm4/wsub-02_t1w_preproc.nii&#39;</span><span class="p">,</span>
    <span class="n">title</span><span class="o">=</span><span class="s1">&#39;anatomy - SPM (normalized to SPM</span><span class="se">\&#39;</span><span class="s1">s TPM)&#39;</span><span class="p">,</span> <span class="n">bg_img</span><span class="o">=</span><span class="n">anatimg</span><span class="p">,</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">,</span> <span class="n">cut_coords</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">50</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">10</span><span class="p">));</span>
</pre></div>
</div>
</div>
</div>
<p>And what about the <strong>contrast</strong> images for <strong>Finger &gt; others</strong>?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">plot_stat_map</span><span class="p">(</span>
    <span class="s1">&#39;/output/datasink/norm_ants/sub-02_fwhm8/con_0005_trans.nii&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;contrast5 - fwhm=8 - ANTs&#39;</span><span class="p">,</span>
    <span class="n">bg_img</span><span class="o">=</span><span class="n">anatimg</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">,</span> <span class="n">cut_coords</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">39</span><span class="p">,</span> <span class="o">-</span><span class="mi">37</span><span class="p">,</span> <span class="mi">56</span><span class="p">));</span>
<span class="n">plot_stat_map</span><span class="p">(</span>
    <span class="s1">&#39;/output/datasink/norm_spm/sub-02_fwhm8/wcon_0005.nii&#39;</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;contrast5 - fwhm=8 - SPM&#39;</span><span class="p">,</span>
    <span class="n">bg_img</span><span class="o">=</span><span class="n">anatimg</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;ortho&#39;</span><span class="p">,</span> <span class="n">cut_coords</span><span class="o">=</span><span class="p">(</span><span class="o">-</span><span class="mi">39</span><span class="p">,</span> <span class="o">-</span><span class="mi">37</span><span class="p">,</span> <span class="mi">56</span><span class="p">));</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">nilearn.plotting</span> <span class="kn">import</span> <span class="n">plot_glass_brain</span>
<span class="n">plot_glass_brain</span><span class="p">(</span>
    <span class="s1">&#39;/output/datasink/norm_ants/sub-02_fwhm8/con_0005_trans.nii&#39;</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;lyrz&#39;</span><span class="p">,</span> <span class="n">black_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;contrast5 - fwhm=8 - ANTs&#39;</span><span class="p">)</span>
<span class="n">plot_glass_brain</span><span class="p">(</span>
    <span class="s1">&#39;/output/datasink/norm_spm/sub-02_fwhm8/wcon_0005.nii&#39;</span><span class="p">,</span> <span class="n">colorbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
    <span class="n">threshold</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">display_mode</span><span class="o">=</span><span class="s1">&#39;lyrz&#39;</span><span class="p">,</span> <span class="n">black_bg</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">6</span><span class="p">,</span> <span class="n">title</span><span class="o">=</span><span class="s1">&#39;contrast5 - fwhm=8 - SPM&#39;</span><span class="p">);</span>
</pre></div>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "python"
        },
        kernelOptions: {
            kernelName: "python3",
            path: "./nipype/notebooks"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'python3'</script>

              </div>
              
        
            



<div class='prev-next-bottom'>
    
    <div id="prev">
        <a class="left-prev" href="example_1stlevel.html" title="previous page">
            <i class="prevnext-label fas fa-angle-left"></i>
            <div class="prevnext-info">
                <p class="prevnext-label">previous</p>
                <p class="prevnext-title">Example 2: 1st-level Analysis</p>
            </div>
        </a>
    </div>
     <div id="next">
        <a class="right-next" href="example_2ndlevel.html" title="next page">
            <div class="prevnext-info">
                <p class="prevnext-label">next</p>
                <p class="prevnext-title">Example 4: 2nd-level Analysis</p>
            </div>
            <i class="prevnext-label fas fa-angle-right"></i>
        </a>
     </div>

</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Peer Herholz<br/>
        
            &copy; Copyright 2021.<br/>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="../../_static/js/index.1c5a1a01449ed65a7b51.js"></script>

  
  </body>
</html>